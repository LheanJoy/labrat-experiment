<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="images/favicon-32x32.png" type="image/png">
  <title>Leaderboard - Lab Rat Experiment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Link to your CSS file -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Basic Reset & Layout */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      font-family: Arial, sans-serif;
      background: url('images/homepage_background.png') no-repeat center center fixed;
      background-size: cover;
    }
    main {
      flex: 1;
      padding: 20px;
    }
    footer {
      text-align: center;
      padding: 15px;
      color: #fff;
      background: linear-gradient(to right, #8806CE, #d6b4fc);
    }
    /* Container for the leaderboard */
    .container {
      max-width: 900px;
      min-height: 600px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #330066;
    }
    h1 {
      text-align: center;
      margin-top: 20px;
    }
    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    table th {
      background: #8806CE;
      color: #fff;
    }
    /* Pagination */
    #pagination {
      margin-top: 20px;
      text-align: center;
    }
    #pagination button {
      padding: 8px 16px;
      margin: 0 5px;
      background: #8806CE;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- HEADER & NAVIGATION -->
  <header>
    <nav class="main-nav">
      <div class="logo">
        <a href="index.html">
          <img src="images/logo.png" alt="Lab Rat Experiment Logo">
          <span class="visually-hidden">Lab Rat Experiment</span>
        </a>
      </div>
      <ul class="nav-list">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="game.html">Game</a></li>
        <!-- Displayed only when authenticated -->
        <li id="leaderboard-link" class="hidden"><a href="leaderboard.html" class="active">Scoreboard</a></li>
        
        <li><a href="contact.html">Contact Us</a></li>
      </ul>
      <div class="account-nav">
        <button id="account-button">Account &#x25BC;</button>
        <ul class="dropdown" id="account-dropdown">
          <li id="profile-link" class="hidden"><a href="profile.html">Profile</a></li>
          <li id="logout-link" class="hidden"><a href="#" id="logout-button">Logout</a></li>
          <li id="login-link"><a href="login.html">Login</a></li>
          <li id="signup-link"><a href="register.html">Sign Up</a></li>
        </ul>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    <div class="container">
      <h1>Scoreboard</h1>
      
      <!-- Leaderboard Table -->
      <table>
         <thead>
           <tr>
             <th>Player Name</th>
             <th>Score</th>
             <th>Level</th>
             <th>Completion Time (sec)</th>
             <th>Current Level</th>
             <th>Date Achieved</th>
           </tr>
         </thead>
         <tbody id="leaderboard-body">
           <!-- Entries will be inserted here dynamically -->
         </tbody>
      </table>
      
      <!-- Pagination Controls -->
      <div id="pagination"></div>
    </div>
  </main>
  
  <footer>
     <p>&copy; 2025 Lab Rat Experiment. All rights reserved.</p>
  </footer>
  
  <!-- Client-Side Scripts -->
  <script>
    /***** Account Dropdown Logic *****/
    document.addEventListener("DOMContentLoaded", function(){
      var accountButton = document.getElementById("account-button");
      var accountDropdown = document.getElementById("account-dropdown");
      if (accountButton && accountDropdown) {
        accountButton.addEventListener("click", function(e) {
           e.stopPropagation();
           accountDropdown.style.display = (accountDropdown.style.display === "block") ? "none" : "block";
        });
      }
      document.addEventListener("click", function() {
         if (accountDropdown) accountDropdown.style.display = "none";
      });
    });

    /***** Leaderboard Pagination & Data Functions *****/
    var leaderboardCache = {}; // Cache for fetched pages
    var currentPage = 1;
    var pageSize = 10;
    
    // Render leaderboard data into the table
    function renderLeaderboard(data) {
      var tbody = document.getElementById("leaderboard-body");
      tbody.innerHTML = "";
      var fragment = document.createDocumentFragment();
      data.forEach(function(record) {
          var row = document.createElement("tr");

          var cellName = document.createElement("td");
          cellName.textContent = record.player_name || "N/A";
          row.appendChild(cellName);

          var cellScore = document.createElement("td");
          cellScore.textContent = (record.score !== undefined) ? record.score : "0";
          row.appendChild(cellScore);

          var cellLevel = document.createElement("td");
          cellLevel.textContent = (record.level !== undefined) ? record.level : "0";
          row.appendChild(cellLevel);

          var cellCompletion = document.createElement("td");
          cellCompletion.textContent = (record.completion_time !== undefined) ? record.completion_time : "N/A";
          row.appendChild(cellCompletion);

          var cellCurrentLevel = document.createElement("td");
          cellCurrentLevel.textContent = (record.current_level !== undefined) ? record.current_level : "N/A";
          row.appendChild(cellCurrentLevel);

          var cellDate = document.createElement("td");
          cellDate.textContent = record.date_achieved || "N/A";
          row.appendChild(cellDate);

          fragment.appendChild(row);
      });
      tbody.appendChild(fragment);
    }

    // Load leaderboard data for the specified page
    function loadLeaderboardPage(page) {
      currentPage = page;
      if (leaderboardCache[page]) {
          renderLeaderboard(leaderboardCache[page]);
          updatePaginationControls();
          if (!leaderboardCache[page + 1]) {
              fetchLeaderboardPage(page + 1);
          }
          return;
      }
      fetchLeaderboardPage(page).then(function(data) {
          renderLeaderboard(data);
          updatePaginationControls();
          if (!leaderboardCache[page + 1]) {
              fetchLeaderboardPage(page + 1);
          }
      }).catch(function(error) {
          console.error("Error fetching leaderboard data for page " + page + ":", error);
      });
    }

    // Fetch leaderboard data from your endpoint
    function fetchLeaderboardPage(page) {
      var url = "../PHP/leaderboard_data.php?page=" + page;
      return fetch(url)
          .then(function(response) {
              return response.json();
          })
          .then(function(data) {
              leaderboardCache[page] = data;
              return data;
          });
    }

    // Update pagination controls based on the current page.
    function updatePaginationControls() {
      var paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = "";
      var prevButton = document.createElement("button");
      prevButton.textContent = "Previous";
      prevButton.disabled = (currentPage === 1);
      prevButton.addEventListener("click", function() {
          if (currentPage > 1) {
              loadLeaderboardPage(currentPage - 1);
          }
      });
      paginationDiv.appendChild(prevButton);

      var pageDisplay = document.createElement("span");
      pageDisplay.style.margin = "0 10px";
      pageDisplay.textContent = "Page " + currentPage;
      paginationDiv.appendChild(pageDisplay);

      var nextButton = document.createElement("button");
      nextButton.textContent = "Next";
      if (leaderboardCache[currentPage] && leaderboardCache[currentPage].length < pageSize) {
          nextButton.disabled = true;
      }
      nextButton.addEventListener("click", function() {
          loadLeaderboardPage(currentPage + 1);
      });
      paginationDiv.appendChild(nextButton);
    }

    // Initial load of the leaderboard.
    loadLeaderboardPage(1);
  </script>
  <!-- Firebase Authentication Integration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
  apiKey: "AIzaSyB4nNmRWksPDQluiW2R1vi-RkWfPo9KUtI",
  authDomain: "lab-rat-experiment.firebaseapp.com",
  projectId: "lab-rat-experiment",
  storageBucket: "lab-rat-experiment.firebasestorage.app",
  messagingSenderId: "1005490252081",
  appId: "1:1005490252081:web:0b6ecb6f448f728f212810"
};

    const appFirebase = initializeApp(firebaseConfig);
    const auth = getAuth(appFirebase);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User signed in:", user);
        // Retrieve username: use displayName if available; otherwise fallback to email.
        const username = user.displayName
                             ? user.displayName
                             : (user.email ? user.email.split('@')[0] : "User");
        document.getElementById("account-button").textContent = username + " â–¼";

        // Display links available only to authenticated users.
        document.getElementById("leaderboard-link").style.display = "block";
        document.getElementById("profile-link").style.display = "block";
        document.getElementById("logout-link").style.display = "block";
        // Hide non-authenticated links.
        document.getElementById("login-link").style.display = "none";
        document.getElementById("signup-link").style.display = "none";
      } else {
        // No user is signed in; hide authenticated-only links.
        document.getElementById("leaderboard-link").style.display = "none";
        document.getElementById("profile-link").style.display = "none";
        document.getElementById("logout-link").style.display = "none";
        // Show non-authenticated links.
        document.getElementById("login-link").style.display = "block";
        document.getElementById("signup-link").style.display = "block";
      }
    });

    const logoutButton = document.getElementById("logout-button");
    if (logoutButton) {
      logoutButton.addEventListener("click", (e) => {
        e.preventDefault();
        signOut(auth)
          .then(() => {
            console.log("User signed out.");
          })
          .catch((error) => {
            console.error("Sign-out error:", error);
          });
      });
    }
  </script>
  
  <!-- Optional: Include your external JavaScript file if needed -->
  <script src="api.js"></script>
</body>
</html>
